---
# Build WordPress and push to GHCR.
name: Build WordPress container

on:
  - push

jobs:
  build:
    name: Build image
    runs-on: ubuntu-24.04
    env:
      IMAGE_NAME: wordpress-redis-pdo_mysql
      IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
      # This does not work for mixed-case usernames.
      # REGISTRY_USER: ${{ github.actor }}
      REGISTRY_PASSWORD: ${{ github.token }}

    steps:

      - name: Clone the repository
        uses: actions/checkout@v3

      # Use Nushell for all scripts.
      - uses: hustcer/setup-nu@v3
        with:
          # Don't use 0.90 here, as it would be a float number and would be converted to 0.9
          # you can use v0.90/0.90.0 or '0.90'
          version: "0.104.1"

      - name: Lowercase repo name
        shell: nu {0}
        run: |
          $"REGISTRY_USER=($env.GITHUB_REPOSITORY_OWNER | str downcase)\n" | save --append $env.GITHUB_ENV

      # - name: Buildah Action
      #   id: build-image
      #   uses: redhat-actions/buildah-build@v2
      #   with:
      #     image: ${{ env.IMAGE_NAME }}
      #     tags: latest ${{ github.sha }}
      #     containerfiles: |
      #       ./Containerfile

      - name: Build image
        id: build-image
        shell: nu {0}
        run: |
          ./wordpress/build.nu

      - name: Log in to the GitHub Container registry
        uses: redhat-actions/podman-login@v1
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Example to push to GHCR: https://github.com/redhat-actions/push-to-registry/blob/main/.github/workflows/ghcr-push.yaml
      - name: Push to GitHub Container Repository
        id: push-to-ghcr
        uses: redhat-actions/push-to-registry@v2
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}

      - name: Print image URL
        run: echo "Image pushed to ${{ steps.push-to-ghcr.outputs.registry-paths }}"
